<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Extrator NFS-e com Controle Manual</title>
  <!-- Adiciona a biblioteca Tesseract.js para OCR -->
  <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
  <style>
    :root{
      --bg:#0b1220;--card:#121a2b;--muted:#8ea0c9;--accent:#5cc8ff;--ok:#18c28e;--warn:#ffb02e;--err:#ff6b6b;--border:#223151;
    }
    html,body{height:100%;}
    body{margin:0;background:linear-gradient(180deg,#0b1220,#0c1426 60%,#0b1220);color:#e6eefc;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif;}
    .container{max-width:1100px;margin:32px auto;padding:0 16px;}
    .title{font-size:clamp(20px,3.5vw,32px);font-weight:800;letter-spacing:.2px;display:flex;align-items:center;gap:10px}
    .badge{font-size:12px;background:linear-gradient(90deg,#112345,#1b2e52);color:#b7c7ef;border:1px solid var(--border);padding:6px 10px;border-radius:999px}
    .card{background:linear-gradient(180deg,#111a2e,#0f182a);border:1px solid var(--border);border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.35);padding:16px}
    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    textarea,input,button,select{font:inherit}
    
    #inputArea { border: 2px dashed var(--border); border-radius: 12px; padding: 10px; background-color: #0c1526; transition: background-color 0.2s, border-color 0.2s; }
    #inputArea.dragover { border-color: var(--accent); background-color: #1a2947; }
    #inputArea p { text-align: center; color: var(--muted); margin: 10px 0; pointer-events: none; }
    #inputArea p strong { color: var(--accent); cursor: pointer; }
    textarea{width:100%;min-height:200px;background:transparent;color:#e7f0ff;border:none;border-radius:12px;padding:12px 14px;line-height:1.4;outline:none;resize:vertical;}
    
    .btn{background:linear-gradient(180deg,#1e2a47,#17233e);border:1px solid var(--border);color:#e7f0ff;border-radius:12px;padding:10px 14px;font-weight:600;cursor:pointer;transition:.15s}
    .btn:hover{transform:translateY(-1px);box-shadow:0 6px 18px rgba(0,0,0,.25)}
    .btn.secondary{background:#0e172a}
    .btn.ghost{background:transparent;border-color:#2a3b63}
    .btn.small{padding:7px 10px;border-radius:10px;font-size:13px}
    .pill{border:1px dashed #2a3b63;background:#0c1427;color:#b7c7ef;padding:8px 10px;border-radius:10px}
    .label{font-size:12px;color:#a9bbeb;}
    .kpi{display:grid;grid-template-columns:repeat(auto-fit, minmax(110px, 1fr));gap:10px;margin-top:10px}
    .kpi .box{background:#0b1427;border:1px solid var(--border);border-radius:14px;padding:10px 12px}
    .kpi .box h4{margin:0 0 4px 0;color:#bcd0ff;font-weight:700;font-size:12px;letter-spacing:.2px}
    .kpi .box .v{font-feature-settings:"tnum" on,"lnum" on; font-variant-numeric:tabular-nums; font-size:16px}
    pre{white-space:pre-wrap;word-wrap:break-word;background:#0b1423;border:1px solid var(--border);border-radius:12px;padding:12px; line-height: 1.5;}
    .out{min-height:180px}
    details{background:#0c1526;border:1px solid var(--border);border-radius:12px;padding:10px}
    summary{cursor:pointer;font-weight:700;color:#c6d6ff}
    .muted{color:#9fb2e7}
    .right-col{display:flex;flex-direction:column;gap:12px}
    
    #ocrStatus { font-size: 12px; color: var(--muted); margin-top: 8px; height: 20px; display:flex; align-items:center; gap: 8px;}
    progress { width: 150px; accent-color: var(--accent); }

    /* Estilos para o seletor manual do Simples Nacional */
    .manual-selector { background:#0b1427; border:1px solid var(--border); border-radius:14px; padding:10px 12px; }
    .manual-selector h4 { margin:0 0 8px 0; color:#bcd0ff; font-weight:700; font-size:12px; letter-spacing:.2px; }
    .btn-group { display: flex; gap: 6px; }
    .btn-group .btn-choice { flex: 1; padding: 6px; font-size: 12px; font-weight: 600; border-radius: 8px; background-color: #17233e; border: 1px solid var(--border); color: var(--muted); cursor: pointer; text-align: center; transition: all 0.2s; }
    .btn-group .btn-choice.active.sim { background-color: var(--ok); border-color: var(--ok); color: #fff; box-shadow: 0 0 10px rgba(24, 194, 142, 0.5); }
    .btn-group .btn-choice.active.nao { background-color: var(--warn); border-color: var(--warn); color: #fff; box-shadow: 0 0 10px rgba(255, 176, 46, 0.5); }
    .btn-group .btn-choice.active.ind { background-color: var(--err); border-color: var(--err); color: #fff; }

  </style>
</head>
<body>
  <div class="container">
    <div class="title">ðŸ§¾ Extrator <span class="badge">NFS-e Â· Cole a imagem e gere um prompt</span></div>

    <div class="card" style="margin-top:14px">
      <div class="row" style="justify-content:space-between">
        <div class="label"><strong>Cole a imagem (print)</strong>, arraste ou <strong id="selectLink" style="color:var(--accent); cursor:pointer;">selecione o arquivo</strong>.</div>
        <div class="row">
          <button id="btnExemplo" class="btn small ghost" type="button">Usar texto de exemplo</button>
          <button id="btnLimpar" class="btn small secondary" type="button">Limpar</button>
          <button id="btnExtrair" class="btn small" type="button">Extrair do Texto</button>
        </div>
      </div>
      
      <div id="inputArea">
        <p>Cole (Ctrl+V), arraste a imagem aqui ou <strong id="selectLink2">clique para selecionar</strong></p>
        <textarea id="input" placeholder="O texto da imagem aparecerÃ¡ aqui para ediÃ§Ã£o..."></textarea>
      </div>
      <input type="file" id="fileInput" accept="image/*" style="display:none;" />
      
      <div id="ocrStatus"></div>

      <div class="grid" style="margin-top:14px">
        <div class="left-col">
          <div class="label">Prompt Gerado para IA</div>
          <pre id="output" class="out" aria-live="polite"></pre>
          <div class="row">
            <button id="btnCopiar" class="btn small" type="button">Copiar Prompt</button>
            <button id="btnDownload" class="btn small ghost" type="button">Baixar Prompt</button>
          </div>
        </div>
        <div class="right-col">
          <div class="label">Campos detectados</div>
          <div class="kpi">
            <div class="box"><h4>Valor total</h4><div id="kpiTotal" class="v">â€”</div></div>
            <div class="box"><h4>Valor lÃ­quido</h4><div id="kpiLiquido" class="v">â€”</div></div>
            <div class="box"><h4>ISS</h4><div id="kpiISS" class="v">â€”</div></div>
            <div class="box"><h4>IRRF</h4><div id="kpiIRRF" class="v">â€”</div></div>
            <div class="box"><h4>CSLL</h4><div id="kpiCSLL" class="v">â€”</div></div>
            <div class="box"><h4>PIS</h4><div id="kpiPIS" class="v">â€”</div></div>
          </div>
          
          <!-- Seletor manual para Simples Nacional -->
          <div class="manual-selector">
            <h4>Simples Nacional</h4>
            <div class="btn-group">
              <div class="btn-choice sim" data-value="true">Sim</div>
              <div class="btn-choice nao" data-value="false">NÃ£o</div>
              <div class="btn-choice ind active" data-value="null">?</div>
            </div>
          </div>

          <details>
            <summary>ConfiguraÃ§Ãµes (sinÃ´nimos & regras)</summary>
            <div class="muted" style="margin:8px 0">Adapte rÃ³tulos. Suas alteraÃ§Ãµes sÃ£o salvas automaticamente.</div>
            <div>
              <div class="label">RÃ³tulos â€” Valor total</div>
              <input id="labelsTotal" style="width:100%" class="pill setting" value="valor total,total dos serviÃ§os,valor total do serviÃ§o,valor bruto,total geral"/>
            </div>
            <div style="margin-top:8px">
              <div class="label">RÃ³tulos â€” Valor lÃ­quido</div>
              <input id="labelsLiquido" style="width:100%" class="pill setting" value="valor lÃ­quido,valor liquido,valor lÃ­quido a receber,lÃ­quido a receber,total lÃ­quido"/>
            </div>
            <div style="margin-top:8px" class="grid" >
              <div><div class="label">RÃ³tulos â€” ISS</div><input id="labelsISS" style="width:100%" class="pill setting" value="iss retido,issqn retido,valor do iss retido,valor do iss"/></div>
              <div><div class="label">RÃ³tulos â€” IRRF</div><input id="labelsIRRF" style="width:100%" class="pill setting" value="irrf retido,irrf,ir retido"/></div>
            </div>
             <div style="margin-top:8px" class="grid" >
              <div><div class="label">RÃ³tulos â€” CSLL</div><input id="labelsCSLL" style="width:100%" class="pill setting" value="csll retida,csll"/></div>
              <div><div class="label">RÃ³tulos â€” PIS/PASEP</div><input id="labelsPIS" style="width:100%" class="pill setting" value="pis,pis/pasep"/></div>
            </div>
            <div style="margin-top:8px" class="grid" >
              <div><div class="label">RÃ³tulos â€” COFINS</div><input id="labelsCOFINS" style="width:100%" class="pill setting" value="cofins,cofins retido"/></div>
              <div><div class="label">RÃ³tulos â€” INSS</div><input id="labelsINSS" style="width:100%" class="pill setting" value="inss,inss retido"/></div>
            </div>
          </details>

          <!-- CORREÃ‡ÃƒO: Elemento de avisos adicionado de volta -->
          <div class="label" style="margin-top:8px">Avisos</div>
          <ul id="avisos" class="muted" style="margin-top:4px; padding-left: 20px;"></ul>

        </div>
      </div>
    </div>
  </div>

  <script>
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));
    const SETTINGS_KEY = 'nfseExtractorSettings_v7_manual';
    
    // Estado global para guardar os dados extraÃ­dos
    let extractedData = null;
    let manualSimplesNacional = null;

    async function preprocessImage(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (event) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const scaleFactor = 2.5;
            canvas.width = img.width * scaleFactor;
            canvas.height = img.height * scaleFactor;
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            for (let i = 0; i < data.length; i += 4) {
              const avg = data[i] * 0.299 + data[i + 1] * 0.587 + data[i + 2] * 0.114;
              data[i] = data[i + 1] = data[i + 2] = avg;
            }
            ctx.putImageData(imageData, 0, 0);
            resolve(canvas.toDataURL('image/png'));
          };
          img.onerror = reject;
          img.src = event.target.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    async function processImageWithOCR(file) {
      if (!file || !file.type.startsWith('image/')) return;
      const statusEl = $('#ocrStatus');
      statusEl.innerHTML = '<span>Preparando imagem...</span>';
      try {
        const processedImage = await preprocessImage(file);
        statusEl.innerHTML = '<progress id="ocrProgress" value="0" max="1"></progress><span>Reconhecendo texto...</span>';
        const progressEl = $('#ocrProgress');
        const worker = await Tesseract.createWorker('por', 1, { logger: m => { if (m.status === 'recognizing text') progressEl.value = m.progress; } });
        const { data: { text } } = await worker.recognize(processedImage);
        await worker.terminate();
        $('#input').value = text;
        statusEl.innerHTML = '<span style="color:var(--ok)">Texto extraÃ­do com sucesso!</span>';
        $('#btnExtrair').click();
      } catch (error) {
        console.error('Erro no OCR:', error);
        statusEl.innerHTML = '<span style="color:var(--err)">Falha ao reconhecer texto.</span>';
      }
    }

    function normalize(str) { return (str || "").toString().normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/\s+/g, ' ').trim().toLowerCase(); }
    function lines(text) { return (text || "").split(/\r?\n/).map(l => l.trim()).filter(Boolean); }
    function parseCurrency(raw) {
      if (raw == null) return null;
      let s = raw.toString().replace(/R\$\s?/gi, '').replace(/\s/g, '');
      const hasComma = /,\d{2}$/.test(s);
      s = hasComma ? s.replace(/\./g, '').replace(',', '.') : s.replace(/,/g, '');
      const num = Number(s.replace(/[^0-9.\-]/g, ''));
      return Number.isFinite(num) ? Number(num.toFixed(2)) : null;
    }
    function fmtBRL(n) { return (n == null || isNaN(n)) ? 'â€”' : n.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }); }

    function findValueByLabels(text, labelList) {
      const L = lines(text);
      const NL = L.map(normalize);
      const labels = labelList.map(s => normalize(s));
      for (let i = 0; i < NL.length; i++) {
        for (const lab of labels) {
          if (NL[i].includes(lab)) {
            let m = L[i].match(/(?:R\$\s*)?(-?\d{1,3}(?:[.\s]\d{3})*(?:,\d{2})|-?\d+(?:[.,]\d{2})?)/);
            if (m && m[0]) return { value: parseCurrency(m[0]) };
          }
        }
      }
      return { value: null };
    }

    function detectSimples(text) {
      const norm = normalize(text);
      if (/(nao|nÃ£o)\s*optante\s*pelo?\s*simples/.test(norm)) return { value: false };
      if (/(optante\s*pelo?\s*simples\s*nacional|simples\s*nacional|mei\b)/.test(norm)) return { value: true };
      return { value: null };
    }

    function extractAll(text) {
      const get = id => $(`#${id}`).value.split(',').map(s => s.trim()).filter(Boolea
