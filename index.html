<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Extrator NFS-e — OCR + Extração + Prompt</title>
  <!-- OCR (Tesseract.js) -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <style>
    :root{ --bg:#0b1220; --card:#111a2e; --muted:#8ea0c9; --accent:#5cc8ff; --ok:#18c28e; --warn:#ffb02e; --err:#ff6b6b; --border:#223151; }
    html,body{height:100%}
    body{margin:0;background:#0b1220;color:#e6eefc;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
    .container{max-width:1100px;margin:24px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.35);padding:14px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    textarea{width:100%;min-height:160px;background:#0c1526;color:#e7f0ff;border:none;border-radius:12px;padding:12px 14px;line-height:1.4}
    .btn{background:#1e2a47;border:1px solid var(--border);color:#e7f0ff;border-radius:10px;padding:8px 12px;font-weight:600;cursor:pointer}
    .btn.ghost{background:transparent}
    .kpi{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:10px;margin-top:8px}
    .kpi .box{background:#0b1427;border:1px solid var(--border);border-radius:12px;padding:10px}
    .kpi .box h4{margin:0 0 6px;color:#bcd0ff;font-size:12px}
    .kpi .v{font-feature-settings:'tnum' on,'lnum' on;font-variant-numeric:tabular-nums}
    pre.out{white-space:pre-wrap;background:#0b1423;border:1px solid var(--border);border-radius:12px;padding:12px;min-height:120px}
    .toggle{background:#0b1427;border:1px solid var(--border);border-radius:12px;padding:10px}
    .toggle h4{margin:0 0 6px;color:#bcd0ff;font-size:12px}
    .btn-group{display:flex;gap:6px}
    .btn-choice{flex:1;text-align:center;padding:6px;border-radius:8px;background:#17233e;border:1px solid var(--border);color:var(--muted);cursor:pointer}
    .btn-choice.active.sim{background:var(--ok);border-color:var(--ok);color:#fff;box-shadow:0 0 12px rgba(24,194,142,.45)}
    .btn-choice.active.nao{background:var(--warn);border-color:var(--warn);color:#fff;box-shadow:0 0 12px rgba(255,176,46,.45)}
    .btn-choice.active.ind{background:var(--err);border-color:var(--err);color:#fff}
    #dropZone{border:2px dashed var(--border);border-radius:12px;padding:12px;text-align:center;background:#0c1526;cursor:pointer}
    #dropZone.dragover{border-color:var(--accent);background:#132344}
    #ocrStatus{font-size:12px;color:var(--muted);min-height:22px;margin-top:6px}
    .label{font-size:12px;color:#a9bbeb;margin-top:8px}
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <div id="dropZone">Cole (Ctrl+V), arraste aqui ou clique para selecionar a imagem da NFS-e</div>
      <input id="fileInput" type="file" accept="image/png,image/jpeg,image/webp,image/bmp,image/gif" style="display:none" />
      <div id="ocrStatus" aria-live="polite"></div>

      <div class="label">Texto (você pode editar antes de extrair)</div>
      <textarea id="input" placeholder="O texto extraído aparecerá aqui..."></textarea>

      <div class="label">Observações (opcional: entra no prompt, ex.: descrição do serviço)</div>
      <textarea id="obs" placeholder="Ex.: serviço referente a banho do cachorro"></textarea>

      <div class="row" style="margin-top:8px">
        <button id="btnExtrair" class="btn">Extrair Dados</button>
        <button id="btnExemplo" class="btn ghost">Usar Exemplo</button>
        <button id="btnCopiarPrompt" class="btn ghost">Copiar Prompt</button>
        <button id="btnBaixarPrompt" class="btn ghost">Baixar Prompt</button>
      </div>
    </div>

    <div class="kpi">
      <div class="box"><h4>Valor total</h4><div id="kpiTotal" class="v">—</div></div>
      <div class="box"><h4>Valor líquido</h4><div id="kpiLiquido" class="v">—</div></div>
      <div class="box"><h4>ISS (retido)</h4><div id="kpiISS" class="v">—</div></div>
      <div class="box"><h4>IRRF</h4><div id="kpiIRRF" class="v">—</div></div>
      <div class="box"><h4>CSLL</h4><div id="kpiCSLL" class="v">—</div></div>
      <div class="box"><h4>PIS</h4><div id="kpiPIS" class="v">—</div></div>
      <div class="box"><h4>COFINS</h4><div id="kpiCOFINS" class="v">—</div></div>
      <div class="box"><h4>INSS</h4><div id="kpiINSS" class="v">—</div></div>
      <div class="box"><h4>ISS devido</h4><div id="kpiISSDev" class="v">—</div></div>
      <div class="box"><h4>Base de cálculo</h4><div id="kpiBase" class="v">—</div></div>
      <div class="box"><h4>Alíquota (%)</h4><div id="kpiAliq" class="v">—</div></div>
      <div class="box"><h4>CNAE</h4><div id="kpiCNAE" class="v">—</div></div>
      <div class="box" style="grid-column:1/-1"><h4>Atividade / Código do serviço</h4><div id="kpiAtividade" class="v">—</div></div>
    </div>

    <div class="row" style="margin-top:10px">
      <div class="toggle" style="flex:1">
        <h4>Simples Nacional</h4>
        <div class="btn-group">
          <div class="btn-choice sim" data-key="simples" data-value="true">Sim</div>
          <div class="btn-choice nao" data-key="simples" data-value="false">Não</div>
          <div class="btn-choice ind" data-key="simples" data-value="null">?</div>
        </div>
      </div>
      <div class="toggle" style="flex:1">
        <h4>Condomínio</h4>
        <div class="btn-group">
          <div class="btn-choice sim" data-key="condominio" data-value="true">Sim</div>
          <div class="btn-choice nao" data-key="condominio" data-value="false">Não</div>
          <div class="btn-choice ind" data-key="condominio" data-value="null">?</div>
        </div>
      </div>
    </div>

    <div class="label" style="margin-top:10px">Prompt Gerado</div>
    <pre id="output" class="out"></pre>

    <details>
      <summary>🧪 Testes rápidos</summary>
      <div class="row"><button id="btnRunTests" class="btn ghost">Executar</button><span id="testsSummary" class="label"></span></div>
      <pre id="testsLog" class="out" style="min-height:60px"></pre>
    </details>
  </div>

  <script>
    const $ = s=>document.querySelector(s);
    const $$ = s=>Array.from(document.querySelectorAll(s));

    let manual = { simples:null, condominio:null };
    let lastData = null;

    // ===== Util =====
    const fmtBRL = n => (n==null||isNaN(n))? '—' : n.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
    const normalize = str => (str||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/\s+/g,' ').trim().toLowerCase();
    function parseCurrency(raw){ if(!raw) return null; let s=String(raw).replace(/R\$\s?/gi,'').replace(/\s/g,''); const hasComma=/,\d{2}$/.test(s); s = hasComma? s.replace(/\./g,'').replace(',', '.') : s.replace(/,/g,''); const num=Number(s.replace(/[^0-9.\-]/g,'')); return Number.isFinite(num)? Number(num.toFixed(2)):null; }

    // ===== OCR =====
    function ocrAvailable(){ return window.Tesseract && typeof Tesseract.recognize==='function'; }
    async function preprocessImage(file){
      const url = URL.createObjectURL(file);
      try{
        const img = await new Promise((res,rej)=>{ const i=new Image(); i.onload=()=>res(i); i.onerror=rej; i.src=url; });
        const canvas=document.createElement('canvas'); const ctx=canvas.getContext('2d',{willReadFrequently:true});
        const scale=2.0; canvas.width=img.width*scale; canvas.height=img.height*scale; ctx.drawImage(img,0,0,canvas.width,canvas.height);
        // grayscale
        const data=ctx.getImageData(0,0,canvas.width,canvas.height); const a=data.data; for(let i=0;i<a.length;i+=4){ const g=.299*a[i]+.587*a[i+1]+.114*a[i+2]; a[i]=a[i+1]=a[i+2]=g; } ctx.putImageData(data,0,0);
        return canvas.toDataURL('image/png');
      } finally{ URL.revokeObjectURL(url); }
    }
    async function processImageWithOCR(file){
      const status = $('#ocrStatus');
      if(!file || !file.type.startsWith('image/')){ status.textContent='Envie uma imagem (PNG/JPG/WEBP/BMP/GIF).'; return; }
      if(!ocrAvailable()){ status.textContent='OCR indisponível; cole o texto manualmente.'; return; }
      status.innerHTML='Preparando imagem...';
      try{
        const processed = await preprocessImage(file);
        status.innerHTML = '<progress id="p" value="0" max="1"></progress> Reconhecendo...';
        const p = $('#p');
        const { data:{ text } } = await Tesseract.recognize(processed,'por+eng',{ logger:m=>{ if(m.status==='recognizing text'){ p.value=m.progress; } } });
        $('#input').value = text; status.textContent='Texto extraído!';
      }catch(e){ console.error('Erro no OCR:', e); status.textContent='Falha no OCR. Cole o texto manualmente.'; }
    }

    // ===== EXTRAÇÃO =====
    function extractISSFields(t){
      const text = (t||'').replace(/\s+/g,' ');
      const ded   = /Valor\s+Total\s+das\s+Dedu[cç][oõ]es\s*\(R\$\)\s*([\d.,]+)/i.exec(text);
      const base  = /Base\s+de\s+C[aá]lculo\s*\(R\$\)\s*([\d.,]+)/i.exec(text);
      const aliq1 = /Al[ií]quota\s*\(%\)\s*([\d.,]+)/i.exec(text) || /Al[ií]quota[^\d%]*([\d.,]+)\s*%/i.exec(text);
      const valor = /Valor\s+do\s+ISS\s*\(R\$\)\s*([\d.,]+)/i.exec(text);
      const cred  = /Cr[eé]dito\s*\(R\$\)\s*([\d.,]+)/i.exec(text);
      return {
        deducoes: ded? parseCurrency(ded[1]):null,
        base_calculo: base? parseCurrency(base[1]):null,
        aliquota_percentual: aliq1? parseCurrency(aliq1[1]):null,
        valor_iss: valor? parseCurrency(valor[1]):null,
        credito: cred? parseCurrency(cred[1]):null
      };
    }
    function extractCNAE(text){
      const m = /(cnae\s*[:#-]?\s*)?(\d{2}\.\d{2}-\d\/?\d{2}|\d{7}\/\d{2})/i.exec(text);
      return m? m[2].replace(/\s+/g,'').trim():null;
    }
    function extractAtividade(text){
      const lines = (text||'').split(/\r?\n/);
      const hits = [];
      for(const l of lines){
        const s = l.trim();
        if(/c[oó]digo\s+do\s+servi[cç]o/i.test(s) || /servi[cç]o\s*:/i.test(s)){
          hits.push(s.replace(/^.*?[:\-]\s*/,'').trim());
        }
      }
      if(!hits.length){
        const m = /(Planos|Consultoria|Servi[cç]os?|Manuten[cç][aã]o|Limpeza|Banho|Tosa)[^\n]{3,}/i.exec(text);
        if(m) hits.push(m[0]);
      }
      return hits.join(' | ') || null;
    }
    function extractRetencoes(text){
      const L = (text||'').split(/\r?\n/);
      const out = { iss:null, irrf:null, csll:null, pis:null, cofins:null, inss:null };
      const map = [ ['iss','iss retid'], ['irrf','irrf'], ['csll','csll'], ['pis','pis'], ['cofins','cofins'], ['inss','inss'] ];
      const rxMoney = /(?:R\$\s*)?(-?\d{1,3}(?:[.\s]\d{3})*(?:,\d{2})|-?\d+(?:[.,]\d{2})?)/;
      for(const line of L){
        const n = normalize(line);
        for(const [k,needle] of map){
          if(n.includes(needle)){
            const m = line.match(rxMoney); if(m) out[k]=parseCurrency(m[0]);
          }
        }
      }
      return out;
    }
    function extractAll(text){
      const total = /VALOR\s+TOTAL\s+DO\s+SERVI[ÇC]O\s*=\s*R\$\s*([\d.,]+)/i.exec(text);
      const liquidoLine = (text||'').split(/\r?\n/).find(l=>/valor\s+l[ií]quido(\s+a\s+receber)?/i.test(l));
      const liquido = liquidoLine? (liquidoLine.match(/(?:R\$\s*)?[\d.,]+/)||[])[0] : null;

      const iss = extractISSFields(text);
      const cnae = extractCNAE(text);
      const atividade = extractAtividade(text);
      const ret = extractRetencoes(text);
      const total_ret = [ret.iss,ret.irrf,ret.csll,ret.pis,ret.cofins,ret.inss].filter(v=>typeof v==='number').reduce((a,b)=>a+b,0);

      let liquidoNum = liquido? parseCurrency(liquido) : null;
      if(liquidoNum==null && total){ liquidoNum = Number((parseCurrency(total[1]) - (total_ret||0)).toFixed(2)); }

      return {
        cnae, atividade,
        valores:{
          valor_total: total? parseCurrency(total[1]):null,
          valor_liquido: liquidoNum,
          retencoes:{...ret, total_retencoes: Number.isFinite(total_ret)? Number(total_ret.toFixed(2)): null}
        },
        apuracao_iss: iss
      };
    }

    // ===== PROMPT =====
    function buildPrompt(d){
      const ret = d.valores.retencoes; const items=[];
      if(ret.iss) items.push(`ISS retido ${fmtBRL(ret.iss)}`);
      if(ret.irrf) items.push(`IRRF ${fmtBRL(ret.irrf)}`);
      if(ret.csll) items.push(`CSLL ${fmtBRL(ret.csll)}`);
      if(ret.pis) items.push(`PIS ${fmtBRL(ret.pis)}`);
      if(ret.cofins) items.push(`COFINS ${fmtBRL(ret.cofins)}`);
      if(ret.inss) items.push(`INSS ${fmtBRL(ret.inss)}`);
      const retStr = items.length? items.join(', ') : 'sem retenções informadas';

      const simplesStr = manual.simples===true? 'prestador optante pelo Simples Nacional' : manual.simples===false? 'prestador não optante pelo Simples Nacional' : 'sem informação de Simples';
      let condStr = '';
      if(manual.condominio===true) condStr = ' O tomador é CONDOMÍNIO.';
      else if(manual.condominio===false) condStr = ' O tomador NÃO é condomínio.';

      const issDev = d.apuracao_iss?.valor_iss; const aliq = d.apuracao_iss?.aliquota_percentual; const base = d.apuracao_iss?.base_calculo;
      const issStr = issDev!=null? `; ISS devido ${fmtBRL(issDev)}${aliq!=null?` (alíquota ${aliq}%)`:''}${base!=null?` sobre base ${fmtBRL(base)}`:''}`:'';

      const cnaeStr = d.cnae? `CNAE ${d.cnae}` : 'CNAE não informado';
      const atvStr = d.atividade? `Atividade: ${d.atividade}` : 'Atividade não informada';

      const obs = ($('#obs').value||'').trim();
      const obsStr = obs? ` Observações: ${obs}` : '';

      return `Analise a NFS-e: valor total ${fmtBRL(d.valores.valor_total)}, ${retStr}. ${simplesStr}${issStr}. ${cnaeStr}. ${atvStr}.${condStr}${obsStr}\nVerifique se as retenções estão corretas para esta operação e explique eventuais divergências.`;
    }

    function render(d){
      $('#kpiTotal').textContent   = fmtBRL(d.valores.valor_total);
      $('#kpiLiquido').textContent = fmtBRL(d.valores.valor_liquido);
      $('#kpiISS').textContent     = fmtBRL(d.valores.retencoes.iss);
      $('#kpiIRRF').textContent    = fmtBRL(d.valores.retencoes.irrf);
      $('#kpiCSLL').textContent    = fmtBRL(d.valores.retencoes.csll);
      $('#kpiPIS').textContent     = fmtBRL(d.valores.retencoes.pis);
      $('#kpiCOFINS').textContent  = fmtBRL(d.valores.retencoes.cofins);
      $('#kpiINSS').textContent    = fmtBRL(d.valores.retencoes.inss);
      $('#kpiISSDev').textContent  = fmtBRL(d.apuracao_iss.valor_iss);
      $('#kpiBase').textContent    = fmtBRL(d.apuracao_iss.base_calculo);
      $('#kpiAliq').textContent    = d.apuracao_iss.aliquota_percentual!=null? `${d.apuracao_iss.aliquota_percentual}%` : '—';
      $('#kpiCNAE').textContent    = d.cnae || '—';
      $('#kpiAtividade').textContent = d.atividade || '—';
      $('#output').textContent = buildPrompt(d);
    }

    // ===== Eventos =====
    function setup(){
      const drop = $('#dropZone'); const file = $('#fileInput');
      drop.addEventListener('click', ()=> file.click());
      drop.addEventListener('dragover', e=>{ e.preventDefault(); drop.classList.add('dragover'); });
      drop.addEventListener('dragleave', ()=> drop.classList.remove('dragover'));
      drop.addEventListener('drop', e=>{ e.preventDefault(); drop.classList.remove('dragover'); const f=e.dataTransfer.files[0]; if(f) processImageWithOCR(f); });
      file.addEventListener('change', e=>{ if(e.target.files[0]) processImageWithOCR(e.target.files[0]); });
      document.addEventListener('paste', e=>{ try{ const items = e.clipboardData && e.clipboardData.items? Array.from(e.clipboardData.items): []; const img = items.find(it=> it.type && it.type.startsWith('image/')); const f = img? img.getAsFile() : (e.clipboardData.files && e.clipboardData.files[0]); if(f) processImageWithOCR(f); }catch(err){ console.error('paste error',err); } });

      $('#btnExtrair').addEventListener('click', ()=>{ lastData = extractAll($('#input').value||''); render(lastData); });
      $('#btnExemplo').addEventListener('click', ()=>{ const exemplo = `VALOR TOTAL DO SERVIÇO = R$ 52,01\nINSS (R$) -\t IRRF (R$) -\t CSLL (R$) -\t COFINS (R$) -\t PIS/PASEP (R$) -\nCódigo do Serviço 06533 - Planos de atendimento e assistência médico-veterinária.\nValor Total das Deduções (R$) 0,00  Base de Cálculo (R$) 52,01  Alíquota (%) 2,00  Valor do ISS (R$) 1,04  Crédito (R$) 0,00\nCNAE 86.90-9/99`; $('#input').value = exemplo; $('#btnExtrair').click(); });
      $('#btnCopiarPrompt').addEventListener('click', async()=>{ try{ await navigator.clipboard.writeText($('#output').textContent); const b=$('#btnCopiarPrompt'); b.textContent='Copiado!'; setTimeout(()=>b.textContent='Copiar Prompt',1200);}catch(e){console.error(e);} });
      $('#btnBaixarPrompt').addEventListener('click', ()=>{ const blob=new Blob([$('#output').textContent],{type:'text/plain'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='prompt-nfse.txt'; a.click(); URL.revokeObjectURL(a.href); });

      // toggles
      $$('.btn-choice').forEach(btn=>{ btn.addEventListener('click', ()=>{ const k=btn.dataset.key; const v=btn.dataset.value; manual[k] = (v==='true')?true : (v==='false')?false : null; btn.parentElement.querySelectorAll('.btn-choice').forEach(b=>b.classList.remove('active','sim','nao','ind')); btn.classList.add('active', v==='true'?'sim': v==='false'?'nao':'ind'); if(lastData) $('#output').textContent = buildPrompt(lastData); }); btn.tabIndex=0; btn.addEventListener('keyup',e=>{ if(e.key==='Enter'||e.key===' ') btn.click();}); });

      // testes
      $('#btnRunTests').addEventListener('click', runTests);
    }

    // ===== Testes =====
    function runTests(){
      const log=[]; let pass=0,fail=0; const ok=x=>{log.push('✅ '+x);pass++;}; const nope=(x,m)=>{log.push('❌ '+x+' -> '+m);fail++;};
      try{ if(parseCurrency('R$ 1.234,56')===1234.56) ok('parseCurrency BRL'); else nope('parseCurrency BRL','valor'); }catch(e){ nope('parseCurrency BRL',e.message); }
      try{ const r = extractISSFields('Base de Cálculo (R$) 52,01 Alíquota (%) 2,00 Valor do ISS (R$) 1,04'); if(r.base_calculo===52.01 && r.aliquota_percentual===2 && r.valor_iss===1.04) ok('extractISSFields'); else nope('extractISSFields','campos'); }catch(e){ nope('extractISSFields',e.message); }
      try{ const r = extractAll('VALOR TOTAL DO SERVIÇO = R$ 52,01\nCNAE 86.90-9/99\nCódigo do Serviço 06533 - Teste'); if(r.valores.valor_total===52.01 && r.cnae && r.atividade) ok('extractAll integração'); else nope('extractAll integração','dados'); }catch(e){ nope('extractAll integração',e.message); }
      $('#testsSummary').textContent = `${pass} passaram, ${fail} falharam`;
      $('#testsLog').textContent = log.join('\n');
    }

    document.addEventListener('DOMContentLoaded', setup);
  </script>
</body>
</html>
